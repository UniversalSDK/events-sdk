function t(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(t);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(t,n[s])&&(i[n[s]]=t[n[s]])}return i}function e(t,e,i,n){return new(i||(i=Promise))(function(s,o){function r(t){try{c(n.next(t))}catch(t){o(t)}}function a(t){try{c(n.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}c((n=n.apply(t,e||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class i{constructor(t){this.sessionId=null,this.sessionStartTime=null,this.lastEventTime=null,this.isInitialized=!1,this.deviceInfo=null,this.eventQueue=[],this.pixelSettings=null,this.platform="web",this.sessionTimeout=18e5,this.autoTrackingSetup=!1,this.scrollThresholds={25:!1,50:!1,75:!1,100:!1},this.timeThresholds={30:!1,60:!1,120:!1},this.pageStartTime=0;const e="https://affiliate.33rd.pro";this.config=Object.assign({baseUrl:`${e}/api/universal-tracker.php`,pixelSettingsUrl:`${e}/api/pixel-settings.php`,debug:!1,enablePixels:!0,autoTrack:{pageViews:!0,clicks:!0,forms:!0,scrolling:!0,timeOnPage:!0}},t),this.storagePrefix=`affiliate_sdk_${this.config.affiliateCode}`,this.handleBeforeUnload=this.handleBeforeUnload.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this)}initialize(){return e(this,void 0,void 0,function*(){try{if(this.isInitialized)return void this.log("SDK already initialized");if("undefined"==typeof window)throw new Error("AffiliateSDK can only be used in browser environment");this.sessionId=this.getOrCreateSessionId(),this.sessionStartTime=Date.now(),this.lastEventTime=Date.now(),this.pageStartTime=Date.now(),this.collectDeviceInfo(),this.config.enablePixels&&(yield this.loadPixelSettings(),this.initializePixels()),yield this.processEventQueue(),this.config.autoTrack&&this.setupAutoTracking(),this.setupPageLifecycle(),this.interceptAnalytics();const t=this.getCookie("aff_attribution");if(t)try{const e=JSON.parse(atob(t));this.log("Found attribution data:",e),yield this.trackEvent("attribution_detected",{click_id:e.click_id,affiliate_code:e.affiliate_code,original_timestamp:e.timestamp,platform:e.platform})}catch(t){this.logError("Failed to parse attribution cookie:",t)}yield this.trackEvent("page_load",Object.assign({session_id:this.sessionId,platform:this.platform},this.deviceInfo)),this.isInitialized=!0,this.log("SDK initialized successfully")}catch(t){throw this.logError("Failed to initialize SDK:",t),t}})}trackEvent(t){return e(this,arguments,void 0,function*(t,e={}){try{const i=this.generateFingerprint(),n={unique_code:this.config.affiliateCode,event_type:t,timestamp:Date.now(),session_id:this.sessionId,fingerprint:i,platform:this.platform,url:window.location.href,referrer:document.referrer,user_agent:navigator.userAgent,screen_resolution:`${screen.width}x${screen.height}`,language:navigator.language,utm_source:this.getURLParameter("utm_source")||"",utm_medium:this.getURLParameter("utm_medium")||"",utm_campaign:this.getURLParameter("utm_campaign")||"",utm_content:this.getURLParameter("utm_content")||"",user_id:e.user_id,amount:e.amount,currency:e.currency,additional_data:JSON.stringify(e)};this.config.appCode&&(n.app_code=this.config.appCode),yield this.sendEvent(n),this.config.enablePixels&&this.pixelSettings&&(yield this.sendToPixels(t,e)),this.lastEventTime=Date.now()}catch(t){this.logError("Failed to track event:",t)}})}trackPageView(t){return e(this,arguments,void 0,function*(t,e={}){const i=t||window.location.pathname;yield this.trackEvent("page_view",Object.assign({page_path:i,page_title:document.title,referrer:document.referrer},e))})}trackPurchase(t){return e(this,void 0,void 0,function*(){const e=Object.assign({amount:t.amount,currency:t.currency||"USD",product_id:t.productId,transaction_id:t.transactionId},t.additionalData);yield this.trackEvent("purchase",e)})}trackSubscriptionStatus(t){return e(this,void 0,void 0,function*(){yield this.trackEvent("subscription_status",{is_premium:t.isActive,subscription_type:t.subscriptionType,expiry_date:t.expiryDate,user_id:t.userId,timestamp:(new Date).toISOString()})})}trackButtonClick(t){return e(this,arguments,void 0,function*(t,e={}){yield this.trackEvent("button_click",Object.assign({button_id:t},e))})}trackFormSubmit(t){return e(this,arguments,void 0,function*(t,e={}){yield this.trackEvent("form_submit",Object.assign({form_name:t},e))})}setUserProperties(t){try{localStorage.setItem(`${this.storagePrefix}_user_props`,JSON.stringify(t)),this.trackEvent("user_properties_set",t)}catch(t){this.logError("Failed to set user properties:",t)}}interceptAnalytics(){const t=console.log,e=this;console.log=function(...i){t.apply(console,i);const n=i[0];if("string"==typeof n)if(n.includes("[Web Analytics]")){const t=n.match(/\[Web Analytics\]\s+(.+?):/);if(t){const n=t[1],s=i[1]||{};e.trackEvent(n,s)}}else if(n.includes("Checking premium status")||n.includes("SUBSCRIPTION CHECK")){const t=i[1]||{};e.trackEvent("subscription_check",{is_premium:t.isActive||t.isPremium||!1,subscription_type:t.subscriptionType||null,expiry_date:t.expiryDate||null,check_type:n.includes("STARTED")?"started":n.includes("COMPLETED")?"completed":"status"})}else if(n.includes("Loaded products:")){const t=i[1]||[];e.trackEvent("products_loaded",{products_count:t.length,products:t})}else if(n.includes("subscription history:")){const t=i[1]||{};e.trackEvent("subscription_history",t)}}}getUserProperties(){try{const t=localStorage.getItem(`${this.storagePrefix}_user_props`);return t?JSON.parse(t):{}}catch(t){return this.logError("Failed to get user properties:",t),{}}}trackSessionEnd(){return e(this,void 0,void 0,function*(){if(!this.sessionStartTime)return;const t=Date.now()-this.sessionStartTime;yield this.trackEvent("session_end",{duration:t,session_id:this.sessionId})})}collectDeviceInfo(){const t=window.screen,e=navigator;this.deviceInfo={user_agent:e.userAgent,screen_width:t.width,screen_height:t.height,viewport_width:window.innerWidth,viewport_height:window.innerHeight,color_depth:t.colorDepth,pixel_ratio:window.devicePixelRatio||1,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:e.language,platform:e.platform,referrer:document.referrer,url:window.location.href}}getOrCreateSessionId(){try{let t=localStorage.getItem(`${this.storagePrefix}_session`);return t||(t=`sess_${Date.now()}_${this.generateRandomString(9)}`,localStorage.setItem(`${this.storagePrefix}_session`,t)),t}catch(t){return this.logError("Failed to get/create session ID:",t),`sess_${Date.now()}_${this.generateRandomString(9)}`}}sendEvent(t){return e(this,void 0,void 0,function*(){try{const e=new URL(this.config.baseUrl);Object.entries(t).forEach(([t,i])=>{null!=i&&e.searchParams.append(t,String(i))});yield fetch(e.toString(),{method:"GET",mode:"cors"});this.log("Event sent successfully:",t.event_type)}catch(e){this.logError("Failed to send event:",e),this.eventQueue.push(Object.assign(Object.assign({},t),{retry_count:0,queued_at:Date.now()}))}})}processEventQueue(){return e(this,void 0,void 0,function*(){if(0===this.eventQueue.length)return;const e=[...this.eventQueue];this.eventQueue=[];for(const i of e)try{if(i.retry_count<3){const{retry_count:e,queued_at:n}=i,s=t(i,["retry_count","queued_at"]);yield this.sendEvent(s)}}catch(t){this.eventQueue.push(Object.assign(Object.assign({},i),{retry_count:i.retry_count+1}))}})}setupAutoTracking(){if(this.autoTrackingSetup)return;const t=this.config.autoTrack;t.clicks&&document.addEventListener("click",this.handleClick.bind(this),!0),t.forms&&document.addEventListener("submit",this.handleFormSubmit.bind(this),!0),t.scrolling&&window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),t.timeOnPage&&this.setupTimeTracking(),this.autoTrackingSetup=!0}handleClick(t){var e,i;const n=t.target;if(!n)return;let s=n,o=0;for(;s&&o<5;){const t=null===(e=s.tagName)||void 0===e?void 0:e.toLowerCase(),n=s.getAttribute("role");if("button"===t||"a"===t||"button"===n||null!==s.onclick||s.classList.contains("btn")||s.classList.contains("button")){this.trackEvent("click",{element_type:t,element_id:s.id||"",element_class:s.className||"",element_text:(null===(i=s.textContent)||void 0===i?void 0:i.trim().substring(0,100))||"",element_role:n||""});break}s=s.parentElement,o++}}handleFormSubmit(t){const e=t.target;e&&"form"===e.tagName.toLowerCase()&&this.trackEvent("form_submit",{form_id:e.id||"",form_name:e.name||"",form_action:e.action||"",form_method:e.method||"get"})}handleScroll(){const t=window.pageYOffset||document.documentElement.scrollTop,e=window.innerHeight,i=document.documentElement.scrollHeight,n=Math.round(t/(i-e)*100);["25","50","75","100"].forEach(t=>{const e=parseInt(t);n>=e&&!this.scrollThresholds[t]&&(this.scrollThresholds[t]=!0,this.trackEvent("scroll_depth",{scroll_percent:e,page_height:i}))})}setupTimeTracking(){setInterval(()=>{const t=Math.round((Date.now()-this.pageStartTime)/1e3);["30","60","120"].forEach(e=>{const i=parseInt(e);t>=i&&!this.timeThresholds[e]&&(this.timeThresholds[e]=!0,this.trackEvent("time_on_page",{time_spent:i,page_url:window.location.href}))})},5e3)}setupPageLifecycle(){window.addEventListener("beforeunload",this.handleBeforeUnload),document.addEventListener("visibilitychange",this.handleVisibilityChange)}handleBeforeUnload(){const t=Math.round((Date.now()-this.pageStartTime)/1e3);if(t>3){const e={affiliate_code:this.config.affiliateCode,app_code:this.config.appCode,event:"page_unload",timestamp:Date.now(),session_id:this.sessionId,time_spent:t,url:window.location.href},i=new URL(this.config.baseUrl);Object.entries(e).forEach(([t,e])=>{i.searchParams.append(t,String(e))}),navigator.sendBeacon&&navigator.sendBeacon(i.toString())}}handleVisibilityChange(){document.hidden?this.trackSessionEnd():this.updateSessionIfNeeded()}updateSessionIfNeeded(){if(!this.lastEventTime)return;Date.now()-this.lastEventTime>this.sessionTimeout&&(this.sessionId=this.getOrCreateSessionId(),this.sessionStartTime=Date.now(),this.pageStartTime=Date.now(),this.trackEvent("session_start",{session_id:this.sessionId,returning_user:!0}))}generateRandomString(t){const e="abcdefghijklmnopqrstuvwxyz0123456789";return Array.from({length:t},()=>e[Math.floor(36*Math.random())]).join("")}generateFingerprint(){let t=0;const e=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,(new Date).getTimezoneOffset(),navigator.platform,this.getCanvasFingerprint()].join("|");for(let i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return Math.abs(t).toString(16)}getCanvasFingerprint(){try{const t=document.createElement("canvas"),e=t.getContext("2d");return e?(e.textBaseline="top",e.font="14px Arial",e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.fillText("Canvas fingerprint",2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.fillText("Canvas fingerprint",4,17),t.toDataURL().slice(-50)):"no-canvas"}catch(t){return"canvas-error"}}getURLParameter(t){return new URLSearchParams(window.location.search).get(t)}getCookie(t){var e;const i=`; ${document.cookie}`.split(`; ${t}=`);if(2===i.length){return(null===(e=i.pop())||void 0===e?void 0:e.split(";").shift())||null}return null}log(...t){this.config.debug&&console.log("[AffiliateSDK]",...t)}logError(...t){this.config.debug&&console.error("[AffiliateSDK Error]",...t)}loadPixelSettings(){return e(this,void 0,void 0,function*(){try{const t=new URL(this.config.pixelSettingsUrl);t.searchParams.append("unique_code",this.config.affiliateCode);const e=yield fetch(t.toString());if(e.ok){const t=yield e.json();this.pixelSettings=t.settings||{},this.log("Pixel settings loaded:",this.pixelSettings)}else this.logError("Failed to load pixel settings:",e.status)}catch(t){this.logError("Error loading pixel settings:",t)}})}initializePixels(){this.pixelSettings&&(this.pixelSettings.facebook_pixel_id&&this.initializeFacebookPixel(this.pixelSettings.facebook_pixel_id),this.pixelSettings.tiktok_pixel_id&&this.initializeTikTokPixel(this.pixelSettings.tiktok_pixel_id),this.pixelSettings.google_ads_id&&this.initializeGoogleAds(this.pixelSettings.google_ads_id))}initializeFacebookPixel(t){try{const e=document.createElement("script");e.innerHTML=`\n        !function(f,b,e,v,n,t,s)\n        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?\n        n.callMethod.apply(n,arguments):n.queue.push(arguments)};\n        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';\n        n.queue=[];t=b.createElement(e);t.async=!0;\n        t.src=v;s=b.getElementsByTagName(e)[0];\n        s.parentNode.insertBefore(t,s)}(window, document,'script',\n        'https://connect.facebook.net/en_US/fbevents.js');\n        fbq('init', '${t}');\n        fbq('track', 'PageView');\n      `,document.head.appendChild(e);const i=document.createElement("noscript"),n=document.createElement("img");n.height=1,n.width=1,n.style.display="none",n.src=`https://www.facebook.com/tr?id=${t}&ev=PageView&noscript=1`,i.appendChild(n),document.head.appendChild(i),this.log("Facebook Pixel initialized:",t)}catch(t){this.logError("Failed to initialize Facebook Pixel:",t)}}initializeTikTokPixel(t){try{const e=document.createElement("script");e.innerHTML=`\n        !function (w, d, t) {\n          w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=i,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=i+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};\n          ttq.load('${t}');\n          ttq.page();\n        }(window, document, 'ttq');\n      `,document.head.appendChild(e),this.log("TikTok Pixel initialized:",t)}catch(t){this.logError("Failed to initialize TikTok Pixel:",t)}}initializeGoogleAds(t){try{const e=document.createElement("script");e.async=!0,e.src=`https://www.googletagmanager.com/gtag/js?id=${t}`,document.head.appendChild(e);const i=document.createElement("script");i.innerHTML=`\n        window.dataLayer = window.dataLayer || [];\n        function gtag(){dataLayer.push(arguments);}\n        gtag('js', new Date());\n        gtag('config', '${t}');\n      `,document.head.appendChild(i),this.log("Google Ads initialized:",t)}catch(t){this.logError("Failed to initialize Google Ads:",t)}}sendToPixels(t,i){return e(this,void 0,void 0,function*(){if(this.pixelSettings)try{this.pixelSettings.facebook_pixel_id&&window.fbq&&this.sendToFacebookPixel(t,i),this.pixelSettings.tiktok_pixel_id&&window.ttq&&this.sendToTikTokPixel(t,i),this.pixelSettings.google_ads_id&&window.gtag&&this.sendToGoogleAds(t,i)}catch(t){this.logError("Error sending to pixels:",t)}})}sendToFacebookPixel(t,e){const i=window.fbq;if(!i)return;const n={page_view:"PageView",purchase:"Purchase",add_to_cart:"AddToCart",button_click:"Contact",form_submit:"Lead",click:"Contact"}[t]||"CustomEvent",s={};e.amount&&(s.value=e.amount),e.currency&&(s.currency=e.currency),e.product_id&&(s.content_ids=[e.product_id]),e.transaction_id&&(s.order_id=e.transaction_id),i("track",n,s),this.log("Facebook Pixel event sent:",n,s)}sendToTikTokPixel(t,e){const i=window.ttq;if(!i)return;const n={page_view:"ViewContent",purchase:"CompletePayment",add_to_cart:"AddToCart",button_click:"Contact",form_submit:"SubmitForm",click:"ClickButton"}[t]||"CustomEvent",s={};e.amount&&(s.value=e.amount),e.currency&&(s.currency=e.currency),e.product_id&&(s.content_id=e.product_id),i.track(n,s),this.log("TikTok Pixel event sent:",n,s)}sendToGoogleAds(t,e){const i=window.gtag;if(!i)return;const n={page_view:"page_view",purchase:"purchase",add_to_cart:"add_to_cart",button_click:"generate_lead",form_submit:"generate_lead",click:"select_content"}[t]||"custom_event",s={};e.amount&&(s.value=e.amount,s.currency=e.currency||"USD"),e.product_id&&(s.item_id=e.product_id),e.transaction_id&&(s.transaction_id=e.transaction_id),i("event",n,s),this.log("Google Ads event sent:",n,s)}}export{i as AffiliateSDK,i as default};
